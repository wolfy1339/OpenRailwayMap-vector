name: Deploy

on:
  workflow_dispatch: ~

jobs:
  deploy-proxy:
    name: Deploy proxy
    runs-on: ubuntu-latest
    environment: proxy-production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      #- name: Setup Fly
      #  uses: superfly/flyctl-actions/setup-flyctl@master

      # Manually write import bounds, to decouple proxy from tile generation/import
      - name: Output import bounds
        run: |
          echo '[[-135.2,42.1], [-53.0, 60.8]]' > data/import/bounds.json

      #- name: Deploy
      #  env:
      #    FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      #  run: |
      #    flyctl deploy --config proxy.fly.toml --local-only

  generate-tiles:
    name: Generate tiles
    runs-on: ubuntu-latest

    strategy:
      matrix:
        # Generate with (Fish shell):
        #   for i in (seq -10 38); echo "- '$i,35,"(math $i + 1)",70'"; end
        bbox:
          - '42,-135,43,-52'
          - '43,-135,44,-52'
          - '44,-135,45,-52'
          - '45,-135,46,-52'
          - '46,-135,47,-52'
          - '47,-135,48,-52'
          - '48,-135,49,-52'
          - '49,-135,50,-52'
          - '50,-135,51,-52'
          - '51,-135,52,-52'
          - '52,-135,53,-52'
          - '53,-135,54,-52'
          - '54,-135,55,-52'
          - '55,-135,56,-52'
          - '56,-135,57,-52'
          - '57,-135,58,-52'
          - '58,-135,59,-52'
          - '59,-135,60,-52'
          - '60,-135,61,-52'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Pull database
        run: |
          docker compose pull db
          docker compose up --no-build --pull never --wait db

      - name: Generate tiles
        env:
          BBOX: ${{ matrix.bbox }}
        run: |
          docker compose run --no-deps martin-cp

          mkdir -p "tiles/split/${{ matrix.bbox }}"
          mv tiles/*.mbtiles "tiles/split/${{ matrix.bbox }}"

      - name: List generated tiles
        run: |
          ls -lah tiles/split/${{ matrix.bbox }}/*.mbtiles

      - uses: actions/upload-artifact@v4
        with:
          name: tiles-${{ matrix.bbox }}
          path: |
            tiles/split
          if-no-files-found: error
          retention-days: 3

  deploy-tiles:
    name: Merge and deploy tiles
    runs-on: ubuntu-latest
    needs: generate-tiles
    environment: tiles-production

    env:
      # Generate with (Fish shell):
      #   for i in (seq -10 38); echo -n "$i,35,"(math $i + 1)",70 "; end
      BBOXES: '42,-135,43,-52 43,-135,44,-52 44,-135,45,-52 45,-135,46,-52 46,-135,47,-52 47,-135,48,-52 48,-135,49,-52 49,-135,50,-52 50,-135,51,-52 51,-135,52,-52 52,-135,53,-52 53,-135,54,-52 54,-135,55,-52 55,-135,56,-52 56,-135,57,-52 57,-135,58,-52 58,-135,59,-52 59,-135,60,-52 60,-135,61,-52'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      #- name: Setup Fly
      #  uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - uses: actions/download-artifact@v4
        with:
          pattern: tiles-*
          merge-multiple: true
          path: tiles/split

      - name: Merge tiles
        run: |
          docker compose run --entrypoint /tiles/merge.sh -e BBOXES --no-deps martin-cp

      - name: Delete split tiles
        run: |
          for bbox in $BBOXES; do
            rm -rf "tiles/split/$bbox"
          done

      - name: List generated tiles
        run: |
          ls -lah tiles/*.mbtiles

      #- name: Deploy
      #  env:
      #    FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      #  run: |
      #    flyctl deploy --config martin-static.fly.toml --local-only

  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    environment: api-production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      #- name: Setup Fly
      #  uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Pull database
        run: |
          docker compose pull db
          docker compose up --no-build --pull never --wait db

      - name: Prepare and build API container
        env:
          SKIP_CLEANUP: 'yes'
        run: |
          api/prepare-api.sh

      - name: Print import logs
        if: ${{ always() }}
        run: |
          docker compose logs api-import

      #- name: Deploy
      #  env:
      #    FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      #  run: |
      #    flyctl deploy --config api.fly.toml --local-only api
